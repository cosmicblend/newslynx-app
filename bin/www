#!/usr/bin/env node

var _ = require('underscore');
// var debug = require('debug')('newslynx-app');
var app = require('../lib/app');
var fs = require('fs');
var http = require('http');
var https = require('https');
// var queue = require('queue-async');
var debug = require('tracer').console();
app.set('port', process.env.PORT || 3000);

function readFileAsUtf8(path, cb){
	fs.readFile(path, 'utf-8', cb);
}

function launchServers(options){
	// debug.log(options)
	// var http_server = http.createServer(app).listen( app.get('port') );
	// TODO, figure out https loading the csr and key files
	var https_server = https.createServer(options, app).listen( app.get('port') );

	// Old can be deleted later
	// var http_server = http.createServer(app).listen(app.get('port'), function() {
	//   message = _.template('Express server listening on port <%= port %> (<%= env %>)')
	//   debug(message({port: server.address().port, env: app.get('env')}));
	// });
}

function loadCerts (){
		var https_options = {
			key: fs.readFileSync('lib/ssl/newslynx/newslynx.key'),
			cert: fs.readFileSync('lib/ssl/gandi-newslynx.crt')
		};
		launchServers(https_options);


	// queue()
	// 	.defer(readFileAsUtf8, 'lib/ssl/newslynx.key')
	// 	.defer(readFileAsUtf8, 'lib/ssl/newslynx.csr')
	// 	.awaitAll(function(err, results){
	// 		var https_options = {
	// 			key: results[0],
	// 			cert: results[1]
	// 		};
	// 		launchServers(https_options);
	// });
}

loadCerts();
// launchServers();